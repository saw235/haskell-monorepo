# BNFC Bazel Rules

This directory contains Bazel rules for integrating BNFC (BNF Converter) into the build system.

## Overview

BNFC is a compiler front-end generator that creates lexers, parsers, and abstract syntax from a grammar specification. This integration provides a seamless way to generate Haskell parsers in Bazel builds.

## Usage

```bazel
load("//tools/bnfc:bnfc.bzl", "bnfc_grammar")

bnfc_grammar(
    name = "my_parser",
    grammar = "MyGrammar.cf",
)

haskell_binary(
    name = "my_app",
    srcs = [
        ":my_parser",
        "Main.hs",
    ],
    deps = [
        "//:base",
        "@stackage//:array",
    ],
)
```

## BNFC Parser Generation Flow

```
BNFC Parser Generation Flow
===========================

Input: Grammar File (.cf)
          │
          ▼
    ┌─────────────┐
    │    BNFC     │ ◄── BNF Converter
    │  -d -m      │     Generates multiple files
    └─────────────┘
          │
          ▼
    Generated Files:
    ┌─────────────────────────────────────┐
    │ • Abs.hs     (Abstract Syntax Tree) │
    │ • Lex.x      (Alex lexer spec)      │ ◄── Input for Alex
    │ • Par.y      (Happy parser spec)    │ ◄── Input for Happy  
    │ • Print.hs   (Pretty printer)       │
    │ • Test.hs    (Test functions)       │
    │ • ErrM.hs    (Error monad)          │
    │ • Skel.hs    (Skeleton code)        │
    │ • Doc.txt    (Documentation)        │
    └─────────────────────────────────────┘
          │
          ├─────────────────┬─────────────────┐
          ▼                 ▼                 ▼
    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
    │    Alex     │   │    Happy    │   │   Direct    │
    │             │   │             │   │   Haskell   │
    │ Lex.x       │   │ Par.y       │   │   Files     │
    │     ↓       │   │     ↓       │   │             │
    │ Lex.hs      │   │ Par.hs      │   │ Abs.hs      │
    │             │   │             │   │ Print.hs    │
    │(Tokenizer)  │   │(Parser)     │   │ Test.hs     │
    └─────────────┘   └─────────────┘   │ ErrM.hs     │
          │                 │           │ Skel.hs     │
          │                 │           └─────────────┘
          └─────────┬───────┘                 │
                    ▼                         │
              ┌─────────────┐                 │
              │  Complete   │ ◄───────────────┘
              │  Haskell    │
              │  Parser     │
              └─────────────┘
                    │
                    ▼
              Your Application
```

## Tool Responsibilities

### BNFC (BNF Converter)
- Takes grammar file (`.cf`) as input
- Generates multiple files including lexer and parser specifications
- Creates abstract syntax tree definitions
- Uses `-d` flag to generate files in a directory
- Uses `-m` flag to generate a makefile

### Alex (Lexer Generator)
- Processes `Lex.x` file generated by BNFC
- Generates `Lex.hs` containing the tokenizer
- Converts input text into tokens

### Happy (Parser Generator)
- Processes `Par.y` file generated by BNFC  
- Generates `Par.hs` containing the parser
- Converts tokens into abstract syntax tree

## Generated Files

- **`Abs.hs`**: Abstract syntax tree data types
- **`Lex.hs`**: Lexical analyzer (generated from `Lex.x` by Alex)
- **`Par.hs`**: Parser (generated from `Par.y` by Happy)
- **`Print.hs`**: Pretty printer for AST
- **`Test.hs`**: Testing utilities
- **`ErrM.hs`**: Error handling monad
- **`Skel.hs`**: Skeleton code for extending the parser
- **`Doc.txt`**: Documentation of the grammar

## Rule Implementation

The `bnfc_grammar` rule:

1. Runs BNFC with `-d -m` flags on the input grammar file
2. Automatically invokes Alex on generated `.x` files
3. Automatically invokes Happy on generated `.y` files
4. Outputs a directory containing all generated Haskell files
5. Integrates seamlessly with `haskell_binary` and `haskell_library` rules

## Dependencies

- BNFC binary (automatically downloaded by the rule)
- Alex (Haskell lexer generator)
- Happy (Haskell parser generator)

Both Alex and Happy are available through the Stackage snapshot defined in the project's MODULE.bazel.